@use '../../../00-tokens/tokens';
@use '../../../01-atoms/atoms';

$secondary-menu-sub-max-width: 19rem;

@mixin secondary-nav-item-level-0 {
  font: var(--font-style-nav-primary-0);
  color: var(--color-heading);
  text-align: left;
  padding: var(--size-spacing-3) var(--size-spacing-5);

  &[aria-expanded='true'] {
    color: var(--color-navigation-expanded-item);
  }

  @media (max-width: tokens.$break-mobile-max) {
    padding: var(--size-spacing-2) var(--size-spacing-5) var(--size-spacing-2);
    margin-block-start: var(--size-spacing-3);
    margin-block-end: var(--size-spacing-3);
  }

  @media (min-width: tokens.$break-mobile) {
    position: relative;
    display: flex;
    align-items: center;
    height: var(--size-in-this-section-control);

    [data-menu-variation='mega'] & {
      border: var(--border-thickness-1) solid transparent;

      .primary-nav__item--level-0:first-child & {
        padding-left: 0;
      }

      .primary-nav__item--level-0:last-child & {
        padding-right: 0;
      }
    }

    &[aria-expanded='true'] {
      z-index: 1;
      border-color: var(--color-navigation-border);
      border-bottom-color: var(--color-background);

      [data-menu-variation='mega'] & {
        :first-child > & {
          padding-left: var(--size-spacing-5);
        }

        :last-child > & {
          padding-right: var(--size-spacing-5);
        }
      }
    }
  }
}

.secondary-nav {
  position: relative;

  .in-this-section__inner & {
    @media (max-width: tokens.$break-mobile-max) {
      @include tokens.animate(
        transform,
        var(--site-in-this-section-animation-speed)
      );

      transform: translateY(-100%);
      overflow: auto;

      [data-secondary-menu-state='closed'] & {
        @include tokens.animate-hidden(
          var(--site-in-this-section-animation-speed)
        );

        transform: translateY(-100%);
        background-color: var(--color-background);
      }

      [data-secondary-menu-state='open'] & {
        border-bottom: var(--border-thickness-4) solid
          var(--color-navigation-border);
        padding-bottom: var(--size-spacing-4);
        background-color: var(--color-gray-100);
        transform: translateY(0%);
      }

      // when used in in-this-section, add a top border
      [aria-expanded='false'] & {
        border-top: var(--border-thickness-2) solid
          var(--color-navigation-border);
        margin-top: var(--size-spacing-3);
      }
    }
  }
}

.secondary-nav__menu {
  @include atoms.list-reset;

  &--level-0 {
    @media (min-width: tokens.$break-mobile) {
      display: flex;
      flex-wrap: wrap;
    }

    [data-menu-variation='basic'] & {
      @media (min-width: tokens.$break-mobile) {
        position: relative;
      }
    }

    .in-this-section & {
      @media (min-width: tokens.$break-mobile) {
        display: flex;
        flex-wrap: nowrap;
        overflow: auto;
        scroll-behavior: smooth;
        -ms-overflow-style: none; /* IE and Edge */
        scrollbar-width: none; /* Firefox */

        &::-webkit-scrollbar {
          display: none;
        }
      }
    }
  }

  &--level-1 {
    @include tokens.animate(max-height, var(--site-header-animation-speed));

    width: 100%;
    overflow: hidden;

    @media (max-width: tokens.$break-mobile-max) {
      // prettier-ignore
      border-left: var(--border-thickness-1) solid var(--color-navigation-border);
      max-height: var(--open-nav-height);
      margin-left: var(--size-spacing-6);
      max-width: calc(100% - var(--size-spacing-6));

      [aria-expanded='true'] ~ & {
        margin-bottom: var(--size-spacing-6);
      }

      [aria-expanded='false'] ~ & {
        @include tokens.animate-hidden(var(--site-header-animation-speed));

        max-height: 0;
      }
    }

    @media (min-width: tokens.$break-mobile) {
      position: fixed;
      background-color: var(--color-background);
      max-width: $secondary-menu-sub-max-width;

      // Subtract enough to place it just behind an "open" toggle and hide the
      // top border. To give it the "tab" effect.
      top: calc(
        var(--size-in-this-section-control) - var(--border-thickness-1)
      );

      [aria-expanded='false'] ~ & {
        display: none;
      }
    }

    [data-menu-variation='mega'] & {
      @media (min-width: tokens.$break-mobile) {
        border: var(--border-thickness-1) solid var(--color-navigation-border);
        border-bottom-width: var(--border-thickness-4);
        padding: var(--size-spacing-7) var(--size-spacing-site-gutter);
        width: calc(100vw - calc(var(--size-spacing-site-gutter) * 2));
        max-width: var(--size-component-layout-width-site);
        column-count: 3;

        [data-site-header-nav-position='center'] &,
        [data-site-header-nav-position='left'] & {
          left: 0;
        }

        // increase max-width if mega menu is left-aligned
        // to align the menu item text with the site name.
        [data-site-header-nav-position='left'] & {
          width: calc(100vw - var(--size-spacing-site-gutter) * 1.2);
        }

        [data-site-header-nav-position='right'] & {
          right: 0;
        }
      }

      @media (min-width: tokens.$break-2xl) {
        column-count: 4;

        [data-site-header-nav-position='left'] & {
          max-width: calc(
            var(--size-component-layout-width-site) + var(--size-spacing-5)
          );
        }
      }
    }

    [data-menu-variation='basic'] & {
      @media (min-width: tokens.$break-mobile) {
        column-count: 1;
        box-shadow: var(--drop-shadow-level-1-bottom-shadow-only);
      }
    }
  }

  &--level-2 {
    margin-left: var(--size-spacing-6);
  }
}

// basic menu variation: border application
@media (min-width: tokens.$break-mobile) {
  .secondary-nav__toggle {
    [data-menu-variation='basic'] :not(:last-child) > & {
      border-top: var(--border-thickness-1) solid transparent;
      border-left: var(--border-thickness-1) solid transparent;
      border-right: var(--border-thickness-1) solid transparent;

      &[aria-expanded='true'] {
        // prettier-ignore
        border-top: var(--border-thickness-1) solid var(--color-navigation-border);
        border-left: var(--border-thickness-1) solid
          var(--color-navigation-border);
        border-right: var(--border-thickness-1) solid
          var(--color-navigation-border);
        border-bottom: var(--border-thickness-1) solid var(--color-background);
      }
    }

    [data-menu-variation='basic'] :last-child > & {
      border-left: var(--border-thickness-1) solid transparent;
      border-right: var(--border-thickness-1) solid transparent;

      &[aria-expanded='true'] {
        border-left: var(--border-thickness-1) solid
          var(--color-navigation-border);
        border-right: var(--border-thickness-1) solid
          var(--color-navigation-border);
      }
    }
  }

  .secondary-nav__menu--level-1 {
    [data-menu-variation='basic'] :not(:last-child) > & {
      // prettier-ignore
      border-top: var(--border-thickness-1) solid var(--color-navigation-border);
      border-left: var(--border-thickness-1) solid
        var(--color-navigation-border);
      border-right: var(--border-thickness-1) solid
        var(--color-navigation-border);
      border-bottom: var(--border-thickness-4) solid
        var(--color-navigation-border);
    }

    [data-menu-variation='basic'] :last-child > & {
      right: 0;

      // prettier-ignore
      border-right: var(--border-thickness-1) solid var(--color-navigation-border);
    }
  }
}

.secondary-nav__item {
  &--level-0 {
    .in-this-section & {
      @include tokens.body-s;

      @media (min-width: tokens.$break-mobile) {
        position: relative;
        flex-shrink: 0;
        display: flex;
      }
    }
  }

  &--level-0:not(:last-child) {
    @media (max-width: tokens.$break-mobile-max) {
      border-bottom: var(--border-thickness-1) solid var(--color-gray-200);
    }
  }

  &--level-1 {
    @media (min-width: tokens.$break-mobile) {
      display: block;
      break-inside: avoid-column;
    }
  }

  &--level-2 {
    margin-bottom: var(--size-spacing-5);
  }

  &--explore-bar {
    [data-menu-variation='mega'] & {
      @media (min-width: tokens.$break-mobile) {
        display: flex;
        column-span: all;
        justify-content: space-between;
        align-items: center;
        position: relative;
        padding-bottom: var(--size-spacing-2);
        border-bottom: var(--border-thickness-1) solid
          var(--color-navigation-border);
        margin-bottom: var(--size-spacing-6);
      }
    }
  }

  .in-this-section & {
    @media (max-width: tokens.$break-mobile-max) {
      [data-in-this-section-overflow='hidden'] & {
        display: none;
      }
    }
  }
}

.secondary-nav__heading {
  [data-menu-variation='mega'] & {
    // hide heading on mobile
    display: none;

    @media (min-width: tokens.$break-mobile) {
      @include tokens.h5-mallory-compact-medium;

      display: block;
      padding: var(--size-spacing-2) var(--size-spacing-5) var(--size-spacing-2)
        calc(var(--size-spacing-2) + var(--size-spacing-1));
      flex: 1 auto;
      color: var(--color-heading);
    }
  }
}

.secondary-nav__link {
  display: block;
  text-decoration: none;

  &:focus-visible {
    outline-offset: -2px;
  }

  &:hover {
    color: var(--menu-link-color);
    text-decoration: underline;
  }

  &--level-0 {
    @include secondary-nav-item-level-0;

    &.secondary-nav__link--with-sub {
      display: none;
    }
  }

  [data-menu-variation='mega']
    // Targets the explore link to the right of a dropdown menu.
    // Only it should be capitalized.
    &.secondary-nav__link--level-1.secondary-nav__link--with-icon.secondary-nav__link--explore-bar {
    @media (min-width: tokens.$break-mobile) {
      @include tokens.h6-mallory-compact-medium;
    }
  }

  &--level-1 {
    font: var(--font-style-nav-secondary-1);
    color: var(--color-heading);
    margin-bottom: var(--size-spacing-3);

    [data-menu-variation='mega'] & {
      padding: var(--size-spacing-2) var(--size-spacing-5) var(--size-spacing-2)
        calc(var(--size-spacing-2) + var(--size-spacing-1));
    }

    [data-menu-variation='basic'] & {
      padding: var(--size-spacing-2) var(--size-spacing-6);
      position: relative;
      margin-bottom: var(--size-spacing-0);

      // basic menu items have a bottom border
      &::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: var(--size-spacing-5);
        right: var(--size-spacing-5);
        height: var(--border-thickness-1);
        background-color: var(--color-gray-200);
      }

      &:last-child > & {
        margin-bottom: 0;
      }

      &:first-child > & {
        padding-top: 0;
      }
    }

    // remove last child's bottom border
    [data-menu-variation='basic'] :last-child > &::after {
      content: unset;
    }
  }

  &--level-2 {
    font: var(--font-style-nav-primary-2);
    color: var(--color-muted);
    padding: var(--size-spacing-2) var(--size-spacing-5) var(--size-spacing-2)
      calc(var(--size-spacing-2) + var(--size-spacing-1));
  }

  // this is used for the explore bar link
  &--with-icon.secondary-nav__link--explore-bar {
    [data-menu-variation='mega'] & {
      font: var(--font-style-nav-primary-1);
      color: var(--color-heading);
      margin-bottom: var(--size-spacing-3);
      padding: var(--size-spacing-2) var(--size-spacing-5) var(--size-spacing-2)
        calc(var(--size-spacing-2) + var(--size-spacing-1));
      z-index: 1;

      &:hover {
        color: var(--menu-link-color);
      }

      @media (min-width: tokens.$break-mobile) {
        flex: 0 1 auto;
        margin-bottom: 0;
        color: inherit;
      }
    }
  }
}

// Active trail styles.
.secondary-nav__link.secondary-nav__link--active {
  color: var(--menu-link-color);
  text-decoration: underline;
  text-decoration-thickness: var(--border-thickness-2);
}

.secondary-nav__link:not(
    .secondary-nav__link--level-0,
    .secondary-nav__link--explore-bar
  ).secondary-nav__link--active {
  position: relative;
  border-left: var(--border-thickness-4) solid var(--color-navigation-border);

  &::before {
    content: ' ';
    display: block;
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    opacity: var(--color-navigation-active-item-link-opacity);
    background-color: var(--color-navigation-active-item-link-background);
  }

  @media (max-width: tokens.$break-mobile-max) {
    // prettier-ignore
    border-left: var(--border-thickness-2) solid var(--color-navigation-border);
  }
}

.secondary-nav__toggle {
  @include atoms.button-reset;

  display: flex;
  align-items: center;
  width: 100%;
  gap: var(--size-spacing-3);

  &:focus-visible {
    outline-offset: -2px;
  }

  &:hover {
    color: var(--menu-link-color);
  }

  &--level-0 {
    @include secondary-nav-item-level-0;
  }

  @media (min-width: tokens.$break-mobile) {
    height: var(--size-in-this-section-control);
  }
}

.secondary-nav__toggle-icon {
  @include tokens.animate;

  height: 1em;
  width: 1em;

  .secondary-nav__toggle[aria-expanded='true'] > & {
    transform: rotate(180deg);
  }
}
